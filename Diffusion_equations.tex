\section{The current diffusion equation}

On the diffusion time scale, the (perpendicular) transport in an axisymmetric tokamak can be described by flux-surface averaged transport (diffusion-convection) equations.
\begin{equation}
\frac{{\partial \left\langle y \right\rangle }}{{\partial t}} - \frac{\partial }{{\partial x}}\left( {D\frac{{\partial \left\langle y \right\rangle }}{{\partial x}} + {v_y}\left\langle y \right\rangle } \right) = {S_y}
\end{equation}
Here, $\left\langle y \right\rangle$ corresponds to flux-averaged quantities,
% MathType!MTEF!2!1!+-
% feaagKart1ev2aaatCvAUfKttLearuqr1ngBPrgarmqr1ngBPrgitL
% xBI9gBamXvP5wqSXMqHnxAJn0BKvguHDwzZbqegm0B1jxALjhiov2D
% aeHbuLwBLnhiov2DGi1BTfMBaebbfv3ySLgzGueE0jxyaibaiKc9yr
% Vq0xXdbba91rFfpec8Eeeu0xXdbba9frFj0-OqFfea0dXdd9vqaq-J
% frVkFHe9pgea0dXdar-Jb9hs0dXdbPYxe9vr0-vr0-vqpWqaaeaabi
% GaciaacaqabeaadaabauaaaOqaaabaaaaaaaaapeWaaaWaa8aabaWd
% biabdMha5bGaayzkJiaawQYiaiabg2da9maalaaapaqaa8qacqGHci
% ITa8aabaWdbiabgkGi2kabdAfawbaadaWdbaWdaeaapeGaemyEaKNa
% eeizaqMaemOvayfaleqabeqdcqGHRiI8aOGaeyypa0ZaaSaaaeaada
% WdfaWdaeaapeWaaSaaa8aabaWdbiabdMha5bWdaeaapeGaemOqai0d
% amaaBaaaleaapeGaeeiCaaNaee4Ba8MaeeiBaWgapaqabaaaaOWdbi
% abbsgaKjabdYgaS9aadaWgaaWcbaWdbiabeI7aXbWdaeqaaaWdbeqa
% beqdcqWIr4E0cqGHRiI8aaGcbaWaa8qba8aabaWdbmaalaaapaqaa8
% qacqaIXaqma8aabaWdbiabdkeac9aadaWgaaWcbaWdbiabbchaWjab
% b+gaVjabbYgaSbWdaeqaaaaak8qacqqGKbazcqWGSbaBpaWaaSbaaS
% qaa8qacqaH4oqCa8aabeaaa8qabeqab0GaeSyeUhTaey4kIipaaaaa
% aa!721B!
\begin{equation}
\left\langle y \right\rangle  = \frac{\partial }{{\partial V}}\int {y{\text{d}}V}  = \frac{{\oint {\frac{y}{{{B_{{\text{pol}}}}}}{\text{d}}{l_\theta }} }}{{\oint {\frac{1}{{{B_{{\text{pol}}}}}}{\text{d}}{l_\theta }} }}
\end{equation}
$\psi$ is the poloidal magnetic flux and $x$ is a normalized flux coordinate, defined as
\begin{equation}
x = \frac{\rho }{{{\rho _{{\text{1}}}}}},\quad \rho  = \sqrt {\frac{\Phi }{{\pi {B_0}}}} 
\end{equation}
$\Phi$ is the toroidal magnetic flux, $\rho_1$ is $\rho$ at the last closed flux surface.
In particular, for the magnetic flux diffusion, generally called
the current diffusion equation (CDE), we have \cite{CRONOSref}
% MathType!MTEF!2!1!+-
% feaagKart1ev2aaatCvAUfKttLearuqr1ngBPrgarmqr1ngBPrgitL
% xBI9gBamXvP5wqSXMqHnxAJn0BKvguHDwzZbqegm0B1jxALjhiov2D
% aeHbuLwBLnhiov2DGi1BTfMBaebbfv3ySLgzGueE0jxyaibaiKc9yr
% Vq0xXdbba91rFfpec8Eeeu0xXdbba9frFj0-OqFfea0dXdd9vqaq-J
% frVkFHe9pgea0dXdar-Jb9hs0dXdbPYxe9vr0-vr0-vqpWqaaeaabi
% GaciaacaqabeaadaabauaaaOqaauaabeqaceaaaeaaqaaaaaaaaaWd
% bmaalaaapaqaa8qacqGHciITcqaHipqEa8aabaWdbiabgkGi2kabds
% ha0baacqGHsisldaWcaaWdaeaapeWaaaWaa8aabaWdbmaaemaapaqa
% a8qacqGHhis0cqaHbpGCaiaawEa7caGLiWoapaWaaWbaaSqabeaape
% GaeGOmaidaaOWdaiabc+caV8qacqWGsbGupaWaaWbaaSqabeaapeGa
% eGOmaidaaaGccaGLPmIaayPkJaaapaqaa8qacqaH8oqBpaWaaSbaaS
% qaa8qacqaIWaama8aabeaak8qacqaHdpWCpaWaaSbaaSqaa8qacqWI
% Licua8aabeaak8qacqaHbpGCpaWaa0baaSqaa8qacqqGXaqma8aaba
% WdbiabikdaYaaakmaaamaapaqaa8qacqaIXaqmpaGaei4la8Ydbiab
% dkfas9aadaahaaWcbeqaa8qacqaIYaGmaaaakiaawMYicaGLQmcaaa
% WaaSaaa8aabaWdbiabgkGi2+aadaahaaWcbeqaa8qacqaIYaGmaaGc
% cqaHipqEa8aabaWdbiabgkGi2kabdIha49aadaahaaWcbeqaa8qacq
% aIYaGmaaaaaOGaeyOeI0capaqaa8qadaGadaqaamaalaaapaqaa8qa
% daaadaWdaeaapeWaaqWaa8aabaWdbiabgEGirlabeg8aYbGaay5bSl
% aawIa7a8aadaahaaWcbeqaa8qacqaIYaGmaaGcpaGaei4la8Ydbiab
% dkfas9aadaahaaWcbeqaa8qacqaIYaGmaaaakiaawMYicaGLQmcaa8
% aabaWdbiabeY7aT9aadaWgaaWcbaWdbiabicdaWaWdaeqaaOWdbiab
% eo8aZ9aadaWgaaWcbaWdbiablwIiqbWdaeqaaOWdbiabeg8aY9aada
% qhaaWcbaWdbiabbgdaXaWdaeaapeGaeGOmaidaaOWaaaWaa8aabaWd
% biabigdaXiabc+caViabdkfas9aadaahaaWcbeqaa8qacqaIYaGmaa
% aakiaawMYicaGLQmcaaaWaaSaaa8aabaWdbiabgkGi2cWdaeaapeGa
% eyOaIyRaemiEaGhaamaadmaapaqaa8qacyGGSbaBcqGGUbGBdaqada
% WdaeaapeWaaSaaa8aabaWdbiqbdAfawzaafaWaaaWaa8aabaWdbmaa
% emaapaqaa8qacqGHhis0cqaHbpGCaiaawEa7caGLiWoapaWaaWbaaS
% qabeaapeGaeGOmaidaaOGaef4la8IaemOuai1damaaCaaaleqabaWd
% biabikdaYaaaaOGaayzkJiaawQYiaaWdaeaapeGaemOrayeaaaGaay
% jkaiaawMcaaaGaay5waiaaw2faaiabgUcaRmaalaaapaqaa8qacqWG
% 4baEa8aabaWdbiabeg8aY9aadaWgaaWcbaWdbiabbgdaXaWdaeqaaa
% aak8qadaWcaaWdaeaapeGaeeizaqMaeqyWdi3damaaBaaaleaapeGa
% eeymaedapaqabaaakeaapeGaeeizaqMaemiDaqhaaaGaay5Eaiaaw2
% haamaalaaapaqaa8qacqGHciITcqaHipqEa8aabaWdbiabgkGi2kab
% dIha4baacqGH9aqpdaWcaaWdaeaapeGaemOqai0damaaBaaaleaape
% GaeGimaadapaqabaaakeaapeGaeq4Wdm3damaaBaaaleaapeGaeSyj
% IafapaqabaGcpeGaemOray0aaaWaa8aabaWdbiabigdaX8aacquGVa
% WlpeGaemOuai1damaaCaaaleqabaWdbiabikdaYaaaaOGaayzkJiaa
% wQYiaaaacqWGQbGApaWaaSbaaSqaa8qacqqGUbGBcqqGPbqAa8aabe
% aaaaaaaa!D313!
\begin{equation}
\begin{array}{*{20}{c}}
  {\frac{{\partial \psi }}{{\partial t}} - \frac{{\left\langle {{{\left| {\nabla \rho } \right|}^2}/{R^2}} \right\rangle }}{{{\mu _0}{\sigma _\parallel }\rho _{\text{1}}^2\left\langle {1/{R^2}} \right\rangle }}\frac{{{\partial ^2}\psi }}{{\partial {x^2}}} - } \\ 
  {\left\{ {\frac{{\left\langle {{{\left| {\nabla \rho } \right|}^2}/{R^2}} \right\rangle }}{{{\mu _0}{\sigma _\parallel }\rho _{\text{1}}^2\left\langle {1/{R^2}} \right\rangle }}\frac{\partial }{{\partial x}}\left[ {\ln \left( {\frac{{V'\left\langle {{{\left| {\nabla \rho } \right|}^2}{\text{/}}{R^2}} \right\rangle }}{F}} \right)} \right] + \frac{x}{{{\rho _{\text{1}}}}}\frac{{{\text{d}}{\rho _{\text{1}}}}}{{{\text{d}}t}}} \right\}\frac{{\partial \psi }}{{\partial x}} = \frac{{{B_0}}}{{{\sigma _\parallel }F\left\langle {1{\text{/}}{R^2}} \right\rangle }}{j_{{\text{ni}}}}} 
\end{array}
\end{equation}
where
% MathType!MTEF!2!1!+-
% feaagKart1ev2aaatCvAUfKttLearuqr1ngBPrgarmqr1ngBPrgitL
% xBI9gBamXvP5wqSXMqHnxAJn0BKvguHDwzZbqegm0B1jxALjhiov2D
% aeHbuLwBLnhiov2DGi1BTfMBaebbfv3ySLgzGueE0jxyaibaiKc9yr
% Vq0xXdbba91rFfpec8Eeeu0xXdbba9frFj0-OqFfea0dXdd9vqaq-J
% frVkFHe9pgea0dXdar-Jb9hs0dXdbPYxe9vr0-vr0-vqpWqaaeaabi
% GaciaacaqabeaadaabauaaaOqaaiqbdAfawzaafaGaeyypa0JaeyOa
% IyRaemOvayLaei4la8IaeyOaIyRaeqyWdihaaa!4A00!
\begin{equation}
V' = \partial V/\partial \rho 
\end{equation}
After using
% MathType!MTEF!2!1!+-
% feaagKart1ev2aaatCvAUfKttLearuqr1ngBPrgarmqr1ngBPrgitL
% xBI9gBamXvP5wqSXMqHnxAJn0BKvguHDwzZbqegm0B1jxALjhiov2D
% aeHbuLwBLnhiov2DGi1BTfMBaebbfv3ySLgzGueE0jxyaibaiKc9yr
% Vq0xXdbba91rFfpec8Eeeu0xXdbba9frFj0-OqFfea0dXdd9vqaq-J
% frVkFHe9pgea0dXdar-Jb9hs0dXdbPYxe9vr0-vr0-vqpWqaaeaabi
% GaciaacaqabeaadaabauaaaOqaauaabeqaceaaaeaaqaaaaaaaaaWd
% biabdEgaN9aadaWgaaWcbaWdbiabigdaXaWdaeqaaOWdbiabg2da9m
% aaamaapaqaa8qacqaIXaqmcqGGVaWlcqWGsbGupaWaaWbaaSqabeaa
% peGaeGOmaidaaaGccaGLPmIaayPkJaaapaqaa8qacqWGNbWzpaWaaS
% baaSqaa8qacqaIYaGma8aabeaak8qacqGH9aqpdaaadaWdaeaapeWa
% aqWaa8aabaWdbiabgEGirlabeg8aYbGaay5bSlaawIa7a8aadaahaa
% Wcbeqaa8qacqaIYaGmaaGccqGGVaWlcqWGsbGupaWaaWbaaSqabeaa
% peGaeGOmaidaaaGccaGLPmIaayPkJaaaaaaa!5C35!
\begin{equation}
\begin{array}{*{20}{c}}
  {{g_1} = \left\langle {1/{R^2}} \right\rangle } \\ 
  {{g_2} = \left\langle {{{\left| {\nabla \rho } \right|}^2}/{R^2}} \right\rangle } 
\end{array}
\end{equation}
the equation can be written as
% MathType!MTEF!2!1!+-
% feaagKart1ev2aaatCvAUfKttLearuqr1ngBPrgarmqr1ngBPrgitL
% xBI9gBamXvP5wqSXMqHnxAJn0BKvguHDwzZbqegm0B1jxALjhiov2D
% aeHbuLwBLnhiov2DGi1BTfMBaebbfv3ySLgzGueE0jxyaibaiKc9yr
% Vq0xXdbba91rFfpec8Eeeu0xXdbba9frFj0-OqFfea0dXdd9vqaq-J
% frVkFHe9pgea0dXdar-Jb9hs0dXdbPYxe9vr0-vr0-vqpWqaaeaabi
% GaciaacaqabeaadaabauaaaOqaaabaaaaaaaaapeWaaSaaa8aabaWd
% biabgkGi2kabeI8a5bWdaeaapeGaeyOaIyRaemiDaqhaaiabgkHiTm
% aalaaapaqaa8qacqWGNbWzdaWgaaWcbaGaeGOmaidabeaaaOWdaeaa
% peGaeqiVd02damaaBaaaleaapeGaeGimaadapaqabaGcpeGaeq4Wdm
% 3damaaBaaaleaapeGaeSyjIafapaqabaGcpeGaeqyWdi3damaaDaaa
% leaapeGaeeymaedapaqaa8qacqaIYaGmaaGcpaGaem4zaC2aaSbaaS
% qaaiabigdaXaqabaaaaOWdbmaadmaabaWaaSaaa8aabaWdbiabgkGi
% 2+aadaahaaWcbeqaa8qacqaIYaGmaaGccqaHipqEa8aabaWdbiabgk
% Gi2kabdIha49aadaahaaWcbeqaa8qacqaIYaGmaaaaaOGaey4kaSYa
% aSaaaeaacqGHciITaeaacqGHciITcqWG4baEaaGagiiBaWMaeiOBa4
% 2aaeWaaeaadaWcaaqaaiqbdAfawzaafaGaem4zaC2aaSbaaSqaaiab
% ikdaYaqabaaakeaacqWGgbGraaaacaGLOaGaayzkaaWaaSaaaeaacq
% GHciITcqaHipqEaeaacqGHciITcqWG4baEaaaacaGLBbGaayzxaaGa
% eyOeI0YaaSaaaeaacqWG4baEaeaacqaHbpGCdaWgaaWcbaGaeGymae
% dabeaaaaGcdaWcaaqaaiabbsgaKjabeg8aYnaaBaaaleaacqaIXaqm
% aeqaaaGcbaGaeeizaqMaemiDaqhaamaalaaabaGaeyOaIyRaeqiYdK
% habaGaeyOaIyRaemiEaGhaaiabg2da9maalaaapaqaa8qacqWGcbGq
% paWaaSbaaSqaa8qacqaIWaama8aabeaaaOqaa8qacqaHdpWCpaWaaS
% baaSqaa8qacqWILicua8aabeaak8qacqWGgbGrcqWGNbWzdaWgaaWc
% baGaeGymaedabeaaaaGccqWGQbGApaWaaSbaaSqaa8qacqqGUbGBcq
% qGPbqAa8aabeaaaaa!9965!
\begin{equation}
\frac{{\partial \psi }}{{\partial t}} - \frac{{{g_2}}}{{{\mu _0}{\sigma _\parallel }\rho _{\text{1}}^2{g_1}}}\left[ {\frac{{{\partial ^2}\psi }}{{\partial {x^2}}} + \frac{\partial }{{\partial x}}\ln \left( {\frac{{V'{g_2}}}{F}} \right)\frac{{\partial \psi }}{{\partial x}}} \right] - \frac{x}{{{\rho _1}}}\frac{{{\text{d}}{\rho _1}}}{{{\text{d}}t}}\frac{{\partial \psi }}{{\partial x}} = \frac{{{B_0}}}{{{\sigma _\parallel }F{g_1}}}{j_{{\text{ni}}}}
\end{equation}

\subsection{Boundary conditions}
On the magnetic axis we have (from the geometry)
\begin{equation}
{\left. {\frac{{\partial \psi }}{{\partial x }}} \right|_{x = 0}} = 0
\end{equation}
On the plasma boundary ($x=1$), the most common boundary condition is 
a prescribed total plasma current
% MathType!MTEF!2!1!+-
% feaagKart1ev2aaatCvAUfKttLearuqr1ngBPrgarmqr1ngBPrgitL
% xBI9gBamXvP5wqSXMqHnxAJn0BKvguHDwzZbqegm0B1jxALjhiov2D
% aeHbuLwBLnhiov2DGi1BTfMBaebbfv3ySLgzGueE0jxyaibaiKc9yr
% Vq0xXdbba91rFfpec8Eeeu0xXdbba9frFj0-OqFfea0dXdd9vqaq-J
% frVkFHe9pgea0dXdar-Jb9hs0dXdbPYxe9vr0-vr0-vqpWqaaeaabi
% GaciaacaqabeaadaabauaaaOqaaabaaaaaaaaapeGaemysaK0damaa
% BaaaleaapeGaeeiCaahapaqabaGcpeGaeyypa0ZaaqGaa8aabaWdbi
% abgkHiTmaalaaapaqaa8qacqaIXaqma8aabaWdbiabikdaYiabec8a
% WjabeY7aT9aadaWgaaWcbaWdbiabicdaWaWdaeqaaaaak8qacuWGwb
% GvgaqbaiabdEgaNnaaBaaaleaacqaIYaGmaeqaaOWaaSaaa8aabaWd
% biabgkGi2kabeI8a5bWdaeaapeGaeyOaIyRaeqyWdihaaaGaayjcSd
% WdamaaBaaaleaapeGaemiEaGNaeyypa0JaeGymaedapaqabaaaaa!5D06!
\begin{equation}
{I_{\text{p}}} = {\left. { - \frac{1}{{2\pi {\mu _0}}}V'{g_2}\frac{{\partial \psi }}{{\partial \rho }}} \right|_{x = 1}}
\end{equation}
In case of free-boundary equilibrium simulations, the plasma current is no longer prescribed.
Hence different boundary conditions must be used. As the magnetic flux must be consistent
in the transport and equilibrium equations, the natural boundary condition (at $x=1$) would be
% MathType!MTEF!2!1!+-
% feaagKart1ev2aaatCvAUfKttLearuqr1ngBPrgarmqr1ngBPrgitL
% xBI9gBamXvP5wqSXMqHnxAJn0BKvguHDwzZbqegm0B1jxALjhiov2D
% aeHbuLwBLnhiov2DGi1BTfMBaebbfv3ySLgzGueE0jxyaibaiKc9yr
% Vq0xXdbba91rFfpec8Eeeu0xXdbba9frFj0-OqFfea0dXdd9vqaq-J
% frVkFHe9pgea0dXdar-Jb9hs0dXdbPYxe9vr0-vr0-vqpWqaaeaabi
% GaciaacaqabeaadaabauaaaOqaaiabeI8a5naaBaaaleaacqqGKbaz
% cqqGPbqAcqqGMbGzcqqGMbGzaeqaaOGaeyypa0JaeqiYdK3aaSbaaS
% qaaiabbwgaLjabbghaXjabbwha1jabbMgaPbqabaaaaa!50E8!
\begin{equation}
\label{eq:bcflux}
{\psi ^{{\text{diff}}}} = {\psi ^{{\text{equi}}}}
\end{equation}
This is similar to prescribing the loop voltage in fixed boundary simulation,
which is known to be prone to numerical errors. For this reason, we have derived two
different boundary conditions for FBE simulations. The first one follows from
(\ref{eq:bcflux}) and using ${L_{\text{i}}}{I_{\text{p}}} = {\psi _0} - {\psi _1}$.
This allows us to calculate an $I_{\text{p}}$ predictor, which enforces
the $\psi$ consistency:
% MathType!MTEF!2!1!+-
% feaagKart1ev2aaatCvAUfKttLearuqr1ngBPrgarmqr1ngBPrgitL
% xBI9gBamXvP5wqSXMqHnxAJn0BKvguHDwzZbqegm0B1jxALjhiov2D
% aeHbuLwBLnhiov2DGi1BTfMBaebbfv3ySLgzGueE0jxyaibaieYdf9
% irVeeu0dXdh9vqqj-hEeeu0xXdbba9frFj0-OqFfea0dXdd9vqaq-J
% frVkFHe9pgea0dXdar-Jb9hs0dXdbPYxe9vr0-vr0-vqpWqaaeaabi
% GaciaacaqabeaadaabauaaaOqaaiabdMeajnaaDaaaleaacqqGWbaC
% aeaacqGHxiIkaaGccqGH9aqpcqWGjbqsdaWgaaWcbaGaeeiCaahabe
% aakmaabmaabaGaeGymaeJaey4kaSYaaSaaaeaacqaHipqEdaqhaaWc
% baGaeGymaedabaGaeeizaqMaeeyAaKMaeeOzayMaeeOzaygaaOGaey
% OeI0IaeqiYdK3aa0baaSqaaiabigdaXaqaaiabbwgaLjabbghaXbaa
% aOqaaiabeI8a5naaDaaaleaacqaIWaamaeaacqqGLbqzcqqGXbqCaa
% GccqGHsislcqaHipqEdaqhaaWcbaGaeGymaedabaGaeeyzauMaeeyC
% aehaaaaaaOGaayjkaiaawMcaaaaa!64D8!
\begin{equation}
I_{\text{p}}^ *  = {I_{\text{p}}}\left( {1 + \frac{{\psi _1^{{\text{diff}}} - \psi _1^{{\text{eq}}}}}{{\psi _0^{{\text{eq}}} - \psi _1^{{\text{eq}}}}}} \right)
\end{equation}
which is then used in (\ref{eq:bcflux}).
The second possibility is similar to the approach in DINA \cite{DINA1993}:
% MathType!MTEF!2!1!+-
% feaagKart1ev2aaatCvAUfKttLearuqr1ngBPrgarmqr1ngBPrgitL
% xBI9gBamXvP5wqSXMqHnxAJn0BKvguHDwzZbqegm0B1jxALjhiov2D
% aeHbuLwBLnhiov2DGi1BTfMBaebbfv3ySLgzGueE0jxyaibaieYdf9
% irVeeu0dXdh9vqqj-hEeeu0xXdbba9frFj0-OqFfea0dXdd9vqaq-J
% frVkFHe9pgea0dXdar-Jb9hs0dXdbPYxe9vr0-vr0-vqpWqaaeaabi
% GaciaacaqabeaadaabauaaaOqaamaalaaabaGaeqiYdK3aaSbaaSqa
% aiabbgdaXaqabaaakeaacuWGmbatgaacamaaBaaaleaacqqGLbqzcq
% qG4baEcqqG0baDaeqaaaaakiabgkHiTiabeo7aNjabdoeadnaaeiaa
% baWaaSaaaeaacqGHciITcqaHipqEaeaacqGHciITcqaHbpGCaaaaca
% GLiWoadaWgaaWcbaGaeqyWdiNaeyypa0JaeGymaedabeaakiabg2da
% 9maalaaabaGaeGymaedabaGafmitaWKbaGaadaWgaaWcbaGaeeyzau
% MaeeiEaGNaeeiDaqhabeaaaaGcdaqadaqaaiqbeI8a5zaaiaWaaSba
% aSqaaiabbgdaXaqabaGccqGHRaWkcqaHipqEdaqhaaWcbaGaeeimaa
% dabaGaeeyzauMaeeiEaGNaeeiDaqhaaOGaeyOeI0IafqiYdKNbaGaa
% daqhaaWcbaGaeeimaadabaGaeeyzauMaeeiEaGNaeeiDaqhaaaGcca
% GLOaGaayzkaaGaey4kaSIafmysaKKbaGaadaWgaaWcbaGaeeiCaaha
% beaakiabc6caUaaa!77E1!
\begin{equation}
\label{eq:bcdina}
\frac{{{\psi _{\text{1}}}}}{{{{\tilde L}_{{\text{ext}}}}}} - \gamma C{\left. {\frac{{\partial \psi }}{{\partial x }}} \right|_{x  = 1}} = \frac{1}{{{{\tilde L}_{{\text{ext}}}}}}\left( {{{\tilde \psi }_{\text{1}}} + \psi _{\text{0}}^{{\text{ext}}} - \tilde \psi _{\text{0}}^{{\text{ext}}}} \right) + {\tilde I_{\text{p}}}.
\end{equation}
where $\gamma  = {L_{{\text{ext}}}}/{\tilde L_{{\text{ext}}}}$.


\section{Equilibrium}

MHD equilibrium is described by the Grad-Shafranov equation

% MathType!MTEF!2!1!+-
% feaagKart1ev2aaatCvAUfKttLearuqr1ngBPrgarmqr1ngBPrgitL
% xBI9gBamXvP5wqSXMqHnxAJn0BKvguHDwzZbqegm0B1jxALjhiov2D
% aeHbuLwBLnhiov2DGi1BTfMBaebbfv3ySLgzGueE0jxyaibaiKc9yr
% Vq0xXdbba91rFfpec8Eeeu0xXdbba9frFj0-OqFfea0dXdd9vqaq-J
% frVkFHe9pgea0dXdar-Jb9hs0dXdbPYxe9vr0-vr0-vqpWqaaeaabi
% GaciaacaqabeaadaabauaaaOqaaiabgs5aenaaCaaaleqabaGaeiOk
% aOcaaOGaeqiYdKNaeyypa0JaeyOeI0IaeqiVd02aaSbaaSqaaiabic
% daWaqabaGccqWGsbGucqWGQbGAdaWgaaWcbaGaeqy1dygabeaakiab
% g2da9iabgkHiTiabeY7aTnaaBaaaleaacqaIWaamaeqaaOGaemOuai
% 1aaWbaaSqabeaacqaIYaGmaaGcdaWcaaqaaiabbsgaKjabdchaWbqa
% aiabbsgaKjabeI8a5baacqGHsisldaWcaaqaaiabigdaXaqaaiabeY
% 7aTnaaBaaaleaacqaIWaamaeqaaaaakiabdAeagnaalaaabaGaeeiz
% aqMaemOrayeabaGaeeizaqMaeqiYdKhaaaaa!6724!
\begin{equation}
-{\Delta ^*}\psi  =  {\mu _0}R{j_\phi } =  {\mu _0}{R^2}\frac{{{\text{d}}p}}{{{\text{d}}\psi }} + F\frac{{{\text{d}}F}}{{{\text{d}}\psi }}
\end{equation}

On the diffusion time scale, this equation is valid for every time instant. 
On the right-hand side appears $p'\left( \psi  \right)$---the pressure gradient---and 
$FF'\left( \psi  \right)$. $p'$ can be calculated from $p\left( x \right)$ and 
$\partial \psi /\partial x$. The calculation of $FF'$ is more difficult.
One possibility, which is currently used in CRONOS and ETS-C, is averaging the G-S
equation. One obtains

% MathType!MTEF!2!1!+-
% feaagKart1ev2aaatCvAUfKttLearuqr1ngBPrgarmqr1ngBPrgitL
% xBI9gBamXvP5wqSXMqHnxAJn0BKvguHDwzZbqegm0B1jxALjhiov2D
% aeHbuLwBLnhiov2DGi1BTfMBaebbfv3ySLgzGueE0jxyaibaiKc9yr
% Vq0xXdbba91rFfpec8Eeeu0xXdbba9frFj0-OqFfea0dXdd9vqaq-J
% frVkFHe9pgea0dXdar-Jb9hs0dXdbPYxe9vr0-vr0-vqpWqaaeaabi
% GaciaacaqabeaadaabauaaaOqaaiabdAeagjqbdAeagzaafaGaeeii
% aaIaeeypa0JaeeiiaaYaaSaaaeaacqaH8oqBdaWgaaWcbaGaeGimaa
% dabeaaaOqaaiabdEgaNnaaBaaaleaacqaIXaqmaeqaaaaakmaabmaa
% baWaaaWaaeaacqWGQbGAdaWgaaWcbaGaeqy1dygabeaakiabc+caVi
% abdkfasbGaayzkJiaawQYiaiabgkHiTiqbdchaWzaafaaacaGLOaGa
% ayzkaaaaaa!5667!
\begin{equation}
FF'{\text{  =  }}\frac{{{\mu _0}}}{{{g_1}}}\left( {\left\langle {{j_\phi }/R} \right\rangle  - p'} \right)
\end{equation}
The average current term can be calculated as
% MathType!MTEF!2!1!+-
% feaagKart1ev2aaatCvAUfKttLearuqr1ngBPrgarmqr1ngBPrgitL
% xBI9gBamXvP5wqSXMqHnxAJn0BKvguHDwzZbqegm0B1jxALjhiov2D
% aeHbuLwBLnhiov2DGi1BTfMBaebbfv3ySLgzGueE0jxyaibaiKc9yr
% Vq0xXdbba91rFfpec8Eeeu0xXdbba9frFj0-OqFfea0dXdd9vqaq-J
% frVkFHe9pgea0dXdar-Jb9hs0dXdbPYxe9vr0-vr0-vqpWqaaeaabi
% GaciaacaqabeaadaabauaaaOqaaabaaaaaaaaapeWaaaWaaeaacqWG
% QbGAdaWgaaWcbaGaeqy1dygabeaakiabc+caViabdkfasbGaayzkJi
% aawQYiaiabg2da9iabgkHiTmaalaaapaqaa8qadaWcaaWdaeaapeGa
% eyOaIylapaqaa8qacqGHciITcqWG4baEaaWaaeWaa8aabaWdbiqbdA
% fawzaafaGaem4zaC2damaaBaaaleaapeGaeGOmaidapaqabaGcpeWa
% aSaaa8aabaWdbiabgkGi2kabeI8a5bWdaeaapeGaeyOaIyRaemiEaG
% haaaGaayjkaiaawMcaaaWdaeaapeGaeqyWdi3damaaDaaaleaapeGa
% eGymaedapaqaa8qacqaIYaGmaaGccqaH8oqBpaWaaSbaaSqaa8qacq
% aIWaama8aabeaak8qacuWGwbGvgaqbaaaaaaa!63BB!
\begin{equation}
\left\langle {{j_\phi }/R} \right\rangle  =  - \frac{{\frac{\partial }{{\partial x}}\left( {V'{g_2}\frac{{\partial \psi }}{{\partial x}}} \right)}}{{\rho _1^2{\mu _0}V'}}
\end{equation}
Since the current density is generally continuous, it follows that
% MathType!MTEF!2!1!+-
% feaagKart1ev2aaatCvAUfKttLearuqr1ngBPrgarmqr1ngBPrgitL
% xBI9gBamXvP5wqSXMqHnxAJn0BKvguHDwzZbqegm0B1jxALjhiov2D
% aeHbuLwBLnhiov2DGi1BTfMBaebbfv3ySLgzGueE0jxyaibaiKc9yr
% Vq0xXdbba91rFfpec8Eeeu0xXdbba9frFj0-OqFfea0dXdd9vqaq-J
% frVkFHe9pgea0dXdar-Jb9hs0dXdbPYxe9vr0-vr0-vqpWqaaeaabi
% GaciaacaqabeaadaabauaaaOqaaiabeI8a5jabgIGiolabdoeadnaa
% CaaaleqabaGaeGOmaidaaOGaeiilaWIaaGjbVlabdEgaNnaaBaaale
% aacqaIYaGmaeqaaOGaeyicI4Saem4qam0aaWbaaSqabeaacqaIXaqm
% aaGccqGGSaalcaaMe8UafmOvayLbauaacqGHiiIZcqWGdbWqdaahaa
% WcbeqaaiabigdaXaaaaaa!56A0!
\begin{equation}
\psi  \in {C^2},\;{g_2} \in {C^1},\;V' \in {C^1}
\end{equation}


\section{(Numerical) challenges}

\begin{enumerate}
\item Boundary conditions
\item Noise from the G-S equation
\item Geometric coefficients smoothness
\item Calculation of $\left\langle {{j_\phi }/R} \right\rangle$ using $\frac{{{\partial ^2}\psi }}{{\partial {x^2}}}$
\item Possible interplay in FF' and G-S calculation
\end{enumerate}

Neumann (\ref{eq:bcflux}) and Robin (\ref{eq:bcdina}) boundary conditions
are not straightforward in a finite difference solver. On top of that, the solution
does not carry the information about the derivatives (an additional bookkeeping
is required).

FBE solvers tend to use rather coarse calculation meshes because of the complexity
and non-linearity of the problem. The results is typically a numerical noise in
$\psi_1$ and geometric coefficients.

This also implies that the geometric coefficients does not have to be smooth enough ($C^1$).
This is of course a problem in the calculation of $\left\langle {{j_\phi }/R} \right\rangle$
as well as in the CDE.

We have to use some kind of smooth interpolation or approximation of $\psi\left( x \right)$ 
in order to calculate $\frac{{{\partial ^2}\psi }}{{\partial {x^2}}}$. 
Splines under tension are typically used in CRONOS. This means that (1) it is only
an approximation, (2) oscillations can (and actually do) appear near $x=1$ 
(even if the exact value of
$\left.{\frac{{\partial \psi }}{{\partial x }}} \right|_{x  = 1}$ is provided).

The $FF'$ calculation takes place in the transport-equilibrium iteration scheme. Since
the averaged G-S equation contains geometric coefficients, there can be an interplay,
which might lead to an instability. This is most recently discussed in \cite{FableScheme2013}.

